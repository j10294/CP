library(mgcv)
library(splines)
library(MASS)
##### paper ë°©ë²• ìˆ˜ì •, ë³€ìˆ˜ë³„ë¡œ ì‹œë“œ 50ë²ˆì”© ë°˜ë³µ í›„ ê²°ê³¼ ì €ì¥ ####

# 0. ë°ì´í„° ì •ë¦¬ 
data <- read.csv('/Users/hdmt306/Downloads/plasma.csv')

exclude_vars <- c("SEX", "SMOKSTAT", "VITUSE", "ALCOHOL")  # ì œì™¸í•  ë²”ì£¼í˜• ë˜ëŠ” ì œì™¸ ëŒ€ìƒ
numeric_vars <- names(data)[sapply(data, is.numeric)]       # ìˆ˜ì¹˜í˜• ë³€ìˆ˜ë§Œ
target_vars <- setdiff(numeric_vars, c("AGE", exclude_vars)) # AGEë„ ì„¤ëª…ë³€ìˆ˜ë¡œ ë‚¨ê¸°ê³  ì œì™¸

#1. í•œ ë²ˆ ì‹œë®¬ë ˆì´ì…˜ í•˜ëŠ” í•¨ìˆ˜ 
library(mgcv)
library(splines)
library(MASS)

find_k_factor <- function(nu, norm_lx_h, P = 0.90, gamma = 0.95) {
  obj_func <- function(k) {
    integral_result <- tryCatch({
      integrate(function(u, k, nu, P, norm_lx_h) {
        pchisq(q = k^2 * (1 + u / nu), df = 1, ncp = norm_lx_h^2) * dchisq(u, df = nu)
      }, lower = 0, upper = 50, k = k, nu = nu, P = P, norm_lx_h = norm_lx_h)$value
    }, error = function(e) return(NA))
    
    pi_term <- sqrt(2 / (pi * norm_lx_h^2))
    return(abs((pi_term * integral_result) - gamma))
  }
  
  result <- tryCatch({
    optimize(obj_func, interval = c(0.01, 10))$minimum
  }, error = function(e) {
    sqrt(nu * qchisq(p = P, df = 1, ncp = norm_lx_h^2) / qchisq(p = 1 - gamma, df = m))
  })
  return(result)
}

run_simulation <- function(y_var, seed, data) {
  set.seed(seed)
  
  result <- tryCatch({
  
    x <- data$AGE
    y <- data[[y_var]]
    
    m <- length(y)
    n_test <- 115
    n_train <- m - n_test
    
    idx <- sample(seq_len(m))
    train_idx <- idx[1:n_train]
    test_idx <- idx[(n_train+1):m]
    
    train_x <- x[train_idx]
    raw_train_y <- y[train_idx]
    test_x <- x[test_idx]
    raw_test_y <- y[test_idx]
    
    raw_fit <- smooth.spline(train_x, raw_train_y, cv=FALSE)
    raw_pred_y <- predict(raw_fit, train_x)$y
    raw_residuals <- raw_train_y - raw_pred_y
    
    variance_fit <- gam(raw_residuals^2 ~ s(train_x))
    var_list <- predict(variance_fit, newdata = data.frame(train_x = x))
    
    transform_y <- y / sqrt(var_list)
    train_y <- transform_y[train_idx]
    test_y <- transform_y[test_idx]
    
    fit <- smooth.spline(train_x, train_y, cv=FALSE)
    residuals <- predict(fit, train_x)$y - train_y
    
    B <- bs(train_x, df=max(fit$df, 3))
    D <- diff(diag(ncol(B)), differences=2)
    S_inv <- ginv(t(B) %*% B + fit$lambda * t(D) %*% D)
    smoother_matrix <- B %*% S_inv %*% t(B)
    I_n <- diag(length(train_x))
    residual_matrix <- I_n - smoother_matrix
    
    estimated_variance <- (t(residuals) %*% residuals) / (sum(diag(t(residual_matrix) %*% residual_matrix)))
    
    compute_norm <- function(v) sqrt(sum(v^2))
    norm_lx_h_values <- apply(smoother_matrix, 1, compute_norm)
    
    numerator <- sum(diag(t(residual_matrix) %*% residual_matrix))^2
    denominator <- sum(diag((t(residual_matrix) %*% residual_matrix)^2))
    nu <- numerator / denominator
    
    k_factors <- sapply(norm_lx_h_values, function(nlh) find_k_factor(nu, nlh))
    
    pred_y <- predict(fit, train_x)$y
    TI_upper <- pred_y + k_factors * sqrt(estimated_variance)
    TI_lower <- pred_y - k_factors * sqrt(estimated_variance)
    
    # ì›ë˜ yë¡œ ë³€í™˜
    raw_TI_upper <- TI_upper * sqrt(var_list[train_idx])
    raw_TI_lower <- TI_lower * sqrt(var_list[train_idx])
    pred_raw_y <- pred_y * sqrt(var_list[train_idx])
    
    # test_x ë³´ê°„
    TI_lower_df <- aggregate(raw_TI_lower ~ train_x, FUN = mean)
    TI_upper_df <- aggregate(raw_TI_upper ~ train_x, FUN = mean)
    
    interp_lower <- approx(x = TI_lower_df$train_x, y = TI_lower_df$raw_TI_lower, xout = test_x)$y
    interp_upper <- approx(x = TI_upper_df$train_x, y = TI_upper_df$raw_TI_upper, xout = test_x)$y
    
    included <- (raw_test_y >= interp_lower) & (raw_test_y <= interp_upper)
    PICP <- mean(included, na.rm=TRUE)
    NMPIW <- mean(interp_upper - interp_lower, na.rm=TRUE) /(max(raw_test_y)-min(raw_test_y))
    
    return(list(
      train_x = train_x,
      pred_y = pred_raw_y,
      raw_TI_lower = raw_TI_lower,
      raw_TI_upper = raw_TI_upper,
      test_x = test_x,
      raw_test_y = raw_test_y,
      PICP = PICP,
      NMPIW = NMPIW
    ))
  }, error = function(e){
    # ì—ëŸ¬ ë°œìƒ ì‹œ, NULLì„ ë°˜í™˜í•˜ê³  ê³„ì† ì§„í–‰
    message("Error in simulation for variable: ", y_var, ", seed: ", seed, " - Skipping.")
    return(NULL)
  })
  
  if (is.null(result)) return(NULL)

  return(result)
}


# 2.  ë°˜ë³µ ì‹¤í–‰ ë° í‰ê·  PICP, NMPIW ê³„ì‚°í•˜ëŠ” ì½”ë“œ
for (y_var in target_vars) {
  cat("â³ ë³€ìˆ˜:", y_var, "ê³„ì‚° ì¤‘...\n")
  
  picp_vals <- numeric(50)
  nmpiw_vals <- numeric(50)
  
  for (seed in 1:50) {
    sim_result <- tryCatch({
      run_simulation(y_var = y_var, seed = seed, data = data)
    }, error = function(e) {
      message("Error in simulation for variable: ", y_var, ", seed: ", seed, " - Skipping.")
      return(NULL)
    })
    
    if (!is.null(sim_result)) {
      picp_vals[seed] <- sim_result$PICP
      nmpiw_vals[seed] <- sim_result$NMPIW
    }
  }
  
  results_list[[y_var]] <- data.frame(
    Variable = y_var,
    Mean_PICP = mean(picp_vals, na.rm = TRUE),
    Mean_NMPIW = mean(nmpiw_vals, na.rm = TRUE)
  )
}

# ëª¨ë“  ê²°ê³¼ë¥¼ í•˜ë‚˜ë¡œ ê²°í•©
summary_results <- do.call(rbind, results_list)

# ê²°ê³¼ ì¶œë ¥
print(summary_results)


# 3. ê·¸ë¦¼ ê·¸ë¦¬ê¸°
library(ggplot2)
library(gridExtra)

# ê·¸ë¦¼ ì €ì¥ í•¨ìˆ˜
save_ti_plot <- function(train_x, pred_y, raw_TI_lower, raw_TI_upper, 
                         test_x, raw_test_y, var_name, seed_num, save_path = ".") {
  
  # tryCatchë¥¼ ì¶”ê°€í•˜ì—¬ ì˜¤ë¥˜ ë°œìƒ ì‹œì—ë„ ê³„ì† ì§„í–‰
  plot_result <- tryCatch({
    plot_df <- data.frame(
      x = train_x,
      pred_y = pred_y,
      TI_lower = raw_TI_lower,
      TI_upper = raw_TI_upper
    )
    
    test_plot_df <- data.frame(
      x = test_x,
      y = raw_test_y
    )
    
    p <- ggplot() +
      geom_ribbon(data = plot_df, aes(x = x, ymin = TI_lower, ymax = TI_upper), fill = "red", alpha = 0.2) +
      geom_line(data = plot_df, aes(x = x, y = pred_y), color = "blue", size = 1) +
      geom_point(data = test_plot_df, aes(x = x, y = y), color = "black", alpha = 0.6) +
      labs(title = paste0(var_name, " (Seed ", seed_num, ")"), x = "AGE", y = var_name) +
      theme_minimal()
    
    return(p)
  }, error = function(e) {
    # ì—ëŸ¬ ë°œìƒ ì‹œ, NULLì„ ë°˜í™˜í•˜ê³  ê³„ì† ì§„í–‰
    message("Error in saving plot for variable: ", var_name, ", seed: ", seed_num, " - Skipping.")
    return(NULL)
  })
  
  # ë§Œì•½ plotì´ NULLì´ë©´ ë°˜í™˜í•˜ì§€ ì•ŠìŒ
  if (is.null(plot_result)) return(NULL)
  
  return(plot_result)
}


# 3x3 ë¬¶ìŒ ì €ì¥
for (var_name in target_vars) {
  cat("ğŸ¨ ê·¸ë¦¼ ì €ì¥ ì¤‘:", var_name, "\n")
  
  for (group_start in seq(1, 50, by = 9)) {
    plots <- list()
    for (s in group_start:min(group_start + 8, 50)) {
      set.seed(s)
      
      result <- run_simulation(y_var = var_name, seed = s, data = data)
      
      # plotting
      p <- save_ti_plot(train_x = result$train_x,
                        pred_y = result$pred_y,
                        raw_TI_lower = result$raw_TI_lower,
                        raw_TI_upper = result$raw_TI_upper,
                        test_x = result$test_x,
                        raw_test_y = result$raw_test_y,
                        var_name = var_name,
                        seed_num = s)
      plots[[length(plots) + 1]] <- p
    }
    
    # ì €ì¥
    filename <- sprintf("TI_paper_%s_seed%02d.png", var_name, group_start)
    ggsave(filename = file.path("plots", filename),
           plot = marrangeGrob(plots, nrow = 3, ncol = 3),
           width = 12, height = 10)
  }
}
